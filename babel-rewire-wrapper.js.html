<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: babel-rewire-wrapper.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: babel-rewire-wrapper.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>function isPromise(obj) {
  return !! obj &amp;&amp; typeof obj['then'] === 'function';
}

/**
 * Rewirer wraps the functionalities of
 * [babel-plugin-rewire]{@link https://github.com/speedskater/babel-plugin-rewire}.
 */
class Rewirer {
  /**
   * Initialize Rewirer.
   */
  constructor() {
    this._targets = [];
  }

  /**
   * Register a specified module as an rewiring target.
   *
   * @param {!*} module - A module to be injected mocks.
   *     The module must have both `__Rewire__` and
   *     `__ResetDependency__` methods added by 'babel-plugin-rewire'.
   * @param {!object} mocks - A hash object like {name: mock}.
   * @return {Rewirer} this instance
   */
  use(module, mocks) {
    if (arguments.length !== 2) {
      throw new Error('Please specify module and mocks');
    }
    if (! this._isRewirable(module)) {
      throw new Error('A module must have __Rewire__ and __ResetDependency__ methods');
    }
    this._targets.push({
      module, mocks
    });
    return this;
  }

  /**
   * Remove a specified module from rewiring targets.
   * If the given module doesn't be registered, does nothing.
   *
   * @param {*} module - A module to be removed from targets.
   * @return {Rewirer} this instance
   */
  remove(module) {
    this._targets = this._targets.filter(target => {
      return target.module !== module;
    });
    return this;
  }

  /**
   * Rewire all dependencies by mocks on the registered modules.
   */
  rewire() {
    this._eachMocks((module, name, mock) => {
      module.__Rewire__(name, mock);
    });
  }

  /**
   * Reset all dependencies which has been replaced with mocks.
   */
  resetDependencies() {
    this._eachMocks((module, name, mock) => {
      module.__ResetDependency__(name, mock);
    });
  }

  /**
   * Run the action. Rewirer automatically injects mocks
   * before running and resets dependencies after running.
   * If the action is async, please returns Promise
   * so that Rewirer can reset dependencies correctly
   * after the async process.
   *
   * @param {!Rewirer~action} action
   * @return {?Promise} Promise if the action is async.
   */
  run(action) {
    let isSync = true;
    this.rewire();

    try {
      const promiseOrElse = action();
      if (isPromise(promiseOrElse)) {
        isSync = false;
        return this._resetDependenciesAlways(promiseOrElse);
      }
      return promiseOrElse;
    }
    finally {
      isSync &amp;&amp; this.resetDependencies();
    }
  }

  _isRewirable(module) {
    return module !== null
      &amp;&amp; module['__Rewire__']
      &amp;&amp; module['__ResetDependency__'];
  }

  _resetDependenciesAlways(promise) {
    return promise.then(
      result => {
        this.resetDependencies();
        return result;
      },
      error => {
        this.resetDependencies();
        throw error;
      }
    );
  }

  _eachMocks(iteratee) {
    this._targets.forEach(({ module, mocks }) => {
      Object.keys(mocks).forEach(name => {
        iteratee(module, name, mocks[name]);
      });
    });
  }

  /**
   * While this callback is running, it is guaranteed
   * that all the registered modules are rewired.
   * If this returns Promise, Rewirer resets dependencies
   * after the Promise is done.
   *
   * @callback Rewirer~action
   */
}

/**
 * A function that creates a new instance of {@link Rewirer}.
 * @module rewire
 */
export default function rewire() {
  return new Rewirer();
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-rewire.html">rewire</a></li></ul><h3>Classes</h3><ul><li><a href="Rewirer.html">Rewirer</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Jan 06 2016 23:52:38 GMT+0900 (JST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
